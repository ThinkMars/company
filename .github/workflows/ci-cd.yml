# CI/CD æµæ°´çº¿é…ç½®
name: CI/CD Pipeline

# æœ¬å·¥ä½œæµç”¨äºè‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½² want-chat å’Œ manager ä¸¤ä¸ªåº”ç”¨
# åŒ…å«ä»¥ä¸‹ä¸»è¦é˜¶æ®µï¼š
# 1. ç¯å¢ƒå‡†å¤‡ (setup)
# 2. åº”ç”¨æ„å»º (build)
# 3. Docker é•œåƒæ„å»º (docker)
# 4. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ (deploy)
# 5. é€šçŸ¥ (notify)

# è§¦å‘æ¡ä»¶ï¼š
# - å½“ main åˆ†æ”¯æœ‰æ¨é€æˆ– PR
# - ä¸”æ›´æ”¹æ¶‰åŠ packages ç›®å½•æˆ–å·¥ä½œæµé…ç½®æ—¶
on:
  push:
    branches: [main]
    paths:
      - "packages/**"
      - ".github/workflows/**"
  workflow_dispatch:

jobs:
  # ç¯å¢ƒå‡†å¤‡é˜¶æ®µ
  setup:
    runs-on: ubuntu-latest # ä½¿ç”¨æœ€æ–°ç‰ˆ Ubuntu ä½œä¸ºè¿è¡Œç¯å¢ƒ
    steps:
      - uses: actions/checkout@v4 # æ£€å‡ºä»£ç 
      - name: Setup Node.js
        uses: actions/setup-node@v4 # è®¾ç½® Node.js ç¯å¢ƒ
        with:
          node-version: "22" # æŒ‡å®š Node.js ç‰ˆæœ¬
      - name: Install PNPM
        uses: pnpm/action-setup@v2 # å®‰è£… PNPM åŒ…ç®¡ç†å™¨
        with:
          version: 9 # æŒ‡å®š PNPM ç‰ˆæœ¬
      - name: Cache dependencies
        uses: actions/cache@v3 # ç¼“å­˜ä¾èµ–ä»¥åŠ é€Ÿåç»­æ„å»º
        id: cache-dependencies
        with:
          path: |
            **/node_modules
            ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }} # ç¼“å­˜é”®
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - name: Install Dependencies
        run: pnpm install # å®‰è£…é¡¹ç›®ä¾èµ–
    outputs:
      cache-hit: ${{ steps.cache-dependencies.outputs.cache-hit }} # è¾“å‡ºç¼“å­˜å‘½ä¸­çŠ¶æ€

  # åº”ç”¨æ„å»ºé˜¶æ®µ
  build:
    needs: setup # ä¾èµ– setup é˜¶æ®µ
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [want-chat, manager] # å¹¶è¡Œæ„å»ºä¸¤ä¸ªåº”ç”¨
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 9
      - name: Restore dependencies
        uses: actions/cache@v3 # æ¢å¤ç¼“å­˜ä¾èµ–
        with:
          path: |
            **/node_modules
            ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - name: Build
        run: pnpm --filter ${{ matrix.app }} build # æ„å»ºæŒ‡å®šåº”ç”¨
      - name: Upload Artifact
        uses: actions/upload-artifact@v4 # ä¸Šä¼ æ„å»ºäº§ç‰©
        with:
          name: ${{ matrix.app }}-dist # äº§ç‰©åç§°
          path: packages/${{ matrix.app }}/dist # äº§ç‰©è·¯å¾„
          retention-days: 7 # äº§ç‰©ä¿ç•™æ—¶é—´

  # Docker é•œåƒæ„å»ºé˜¶æ®µ
  docker:
    needs: build # ä¾èµ– build é˜¶æ®µ
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [want-chat, manager] # å¹¶è¡Œæ„å»ºä¸¤ä¸ªåº”ç”¨çš„ Docker é•œåƒ
    steps:
      - uses: actions/checkout@v4
      - name: Download Artifact
        uses: actions/download-artifact@v4 # ä¸‹è½½æ„å»ºäº§ç‰©
        with:
          name: ${{ matrix.app }}-dist
          path: packages/${{ matrix.app }}/dist
      - name: Build Docker Image
        working-directory: packages/${{ matrix.app }} # è®¾ç½®å·¥ä½œç›®å½•
        run: |
          docker build -t ${{ matrix.app }}:${{ github.sha }} .
      - name: Login to Docker Registry
        # ä»…åœ¨ main åˆ†æ”¯æ‰§è¡Œ
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3 # ç™»å½• Docker ä»“åº“
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }} # ä» secrets è·å–ä»“åº“åœ°å€
          username: ${{ secrets.DOCKER_USERNAME }} # ä» secrets è·å–ç”¨æˆ·å
          password: ${{ secrets.DOCKER_PASSWORD }} # ä» secrets è·å–å¯†ç 
      - name: Push Docker Image
        # ä»…åœ¨ main åˆ†æ”¯æ‰§è¡Œ
        if: github.ref == 'refs/heads/main'
        run: |
          docker tag ${{ matrix.app }}:${{ github.sha }} ${{ secrets.DOCKER_REGISTRY }}/${{ matrix.app }}:latest
          docker push ${{ secrets.DOCKER_REGISTRY }}/${{ matrix.app }}:latest

  # éƒ¨ç½²é˜¶æ®µ
  deploy:
    needs: docker # ä¾èµ– docker é˜¶æ®µ
    runs-on: ubuntu-latest
    # ä»…åœ¨ main åˆ†æ”¯æ‰§è¡Œ
    if: github.ref == 'refs/heads/main'
    strategy:
      matrix:
        app: [want-chat, manager] # å¹¶è¡Œéƒ¨ç½²ä¸¤ä¸ªåº”ç”¨
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@v1.0.0 # ä½¿ç”¨ SSH è¿æ¥åˆ°æœåŠ¡å™¨
        with:
          host: ${{ secrets.ALIYUN_HOST }} # é˜¿é‡Œäº‘ä¸»æœºåœ°å€
          username: ${{ secrets.ALIYUN_USER }} # é˜¿é‡Œäº‘ç”¨æˆ·å
          key: ${{ secrets.ALIYUN_SSH_KEY }} # SSH ç§é’¥
          script: |
            cd /docker/
            if [ ! -f docker-compose.yml ]; then
              echo "docker-compose.yml ä¸å­˜åœ¨ï¼"
              exit 1
            fi
            echo "åœæ­¢å¹¶åˆ é™¤ ${{ matrix.app }} å®¹å™¨..."
            docker-compose stop ${{ matrix.app }} && docker-compose rm -f ${{ matrix.app }}
            echo "åˆ é™¤æ—§çš„ ${{ matrix.app }} é•œåƒ..."
            docker rmi -f ${{ secrets.DOCKER_REGISTRY }}/${{ matrix.app }}:latest
            echo "æ‹‰å–æœ€æ–°çš„ ${{ matrix.app }} é•œåƒ..."
            docker pull ${{ secrets.DOCKER_REGISTRY }}/${{ matrix.app }}:latest
            echo "åˆ›å»ºå®¹å™¨å¯åŠ¨ ${{ matrix.app }} æœåŠ¡..."
            docker-compose up -d --no-deps ${{ matrix.app }}

  # é€šçŸ¥é˜¶æ®µ
  notify:
    needs: deploy # ä¾èµ– deploy é˜¶æ®µ
    runs-on: ubuntu-latest
    if: success() || failure()
    strategy:
      matrix:
        app: [want-chat, manager] # å¹¶è¡Œéƒ¨ç½²ä¸¤ä¸ªåº”ç”¨
    steps:
      - name: Notify
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "åº”ç”¨: ${{ matrix.app }}"
            echo "é•œåƒ: ${{ secrets.DOCKER_REGISTRY }}/${{ matrix.app }}:latest"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
            echo "åº”ç”¨: ${{ matrix.app }}"
          fi

  #     # é‚®ä»¶é€šçŸ¥
  #     - name: Email Notification
  #       if: always()
  #       uses: dawidd6/action-send-mail@v3
  #       with:
  #         server_address: smtp.126.com # 126 é‚®ç®±çš„ SMTP æœåŠ¡å™¨åœ°å€
  #         server_port: 465 # 126 é‚®ç®±çš„ SMTP ç«¯å£ï¼ˆSSLï¼‰
  #         username: ${{ secrets.EMAIL_USERNAME }} # 126 é‚®ç®±åœ°å€
  #         password: ${{ secrets.EMAIL_PASSWORD }} # 126 é‚®ç®±çš„æˆæƒç 
  #         subject: "CI/CD Notification: ${{ github.repository }} (${{ needs.build.result }})"
  #         to: ${{ secrets.RECIPIENT_EMAIL }}
  #         from: GitHub Actions
  #         body: |
  #           ğŸš¦ Status: ${{ needs.build.result }}
  #           ğŸ“¦ Repo: ${{ github.repository }}
  #           ğŸŒ¿ Branch: ${{ github.ref_name }}
  #           ğŸ’¬ Message: ${{ github.event.head_commit.message }}
  #           ğŸ”— Detail: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
