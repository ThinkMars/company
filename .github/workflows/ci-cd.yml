# CI/CD 流水线配置
name: CI/CD Pipeline

# 本工作流用于自动化构建、测试和部署应用
# 包含以下主要阶段：
# 1. 环境准备 (setup)
# 2. 应用构建 (build)
# 3. Docker 镜像构建 (docker)
# 4. 部署到生产环境 (deploy)
# 5. 通知 (notify)

# 触发条件：
# - 当 main 分支有推送
# - 且更改涉及 packages 目录或工作流配置时
on:
  push:
    branches: [dev]
    paths:
      - "packages/**"
      - ".github/workflows/**"
  workflow_dispatch:
    inputs:
      package:
        description: "选择要构建的包"
        required: true
        type: choice
        options:
          - want-chat
          - manager
          - all
        default: all

jobs:
  # 检测变更阶段
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-packages: ${{ steps.detect.outputs.changed-packages }}
    steps:
      - uses: actions/checkout@v4
      - name: Get changed packages
        id: detect
        run: |
          # 如果是手动触发，使用用户选择的包
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.package }}" == "all" ]]; then
              changed_packages=("want-chat" "manager")
            else
              changed_packages=("${{ github.event.inputs.package }}")
            fi
          else
            # 自动触发时检测变更
            # 检查是否是首次提交
            if git rev-list --count HEAD > /dev/null 2>&1 && [ $(git rev-list --count HEAD) -gt 1 ]; then
              changed_files=$(git diff --name-only HEAD^ HEAD)
            else
              # 首次提交时列出所有文件
              changed_files=$(git ls-tree -r HEAD --name-only)
            fi
            
            changed_packages=()
            for pkg in want-chat manager; do
              if echo "$changed_files" | grep -q "^packages/$pkg/"; then
                changed_packages+=("$pkg")
              fi
            done
          fi

          # 将变更的package列表转换为JSON格式
          json_packages=$(printf '%s\n' "${changed_packages[@]}" | jq -R . | jq -s -c .)
          echo "changed-packages=$json_packages" >> $GITHUB_OUTPUT

  # 环境准备阶段
  build:
    runs-on: ubuntu-latest
    needs: detect-changes
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.changed-packages) }}
    steps:
      - uses: actions/checkout@v4 # 检出代码

      - name: Setup Node.js
        uses: actions/setup-node@v4 # 设置 Node.js 环境
        with:
          node-version: "22" # 指定 Node.js 版本

      - name: Install PNPM
        uses: pnpm/action-setup@v2 # 安装 PNPM 包管理器
        with:
          version: 9 # 指定 PNPM 版本

      - name: Cache dependencies
        uses: actions/cache@v3 # 缓存依赖以加速后续构建
        id: cache-dependencies
        with:
          path: |
            **/node_modules
            ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }} # 缓存键
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install Dependencies
        run: pnpm install # 安装项目依赖

      - name: Build
        run: pnpm --filter ${{ matrix.app }} build # 构建指定应用

      - name: Upload Artifact
        uses: actions/upload-artifact@v4 # 上传构建产物
        with:
          name: ${{ matrix.app }}-dist # 产物名称
          path: packages/${{ matrix.app }}/dist # 产物路径
          retention-days: 7 # 产物保留时间

    outputs:
      cache-hit: ${{ steps.cache-dependencies.outputs.cache-hit }} # 输出缓存命中状态

  # Docker 镜像构建阶段
  docker:
    needs: [build, detect-changes]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.changed-packages) }}

    steps:
      - uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4 # 下载构建产物
        with:
          name: ${{ matrix.app }}-dist
          path: packages/${{ matrix.app }}/dist

      - name: Build Docker Image
        working-directory: packages/${{ matrix.app }} # 设置工作目录
        run: |
          docker build -t ${{ matrix.app }}:${{ github.sha }} .

      - name: Login to Docker Registry
        # 仅在 main 分支执行
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3 # 登录 Docker 仓库
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }} # 从 secrets 获取仓库地址
          username: ${{ secrets.DOCKER_USERNAME }} # 从 secrets 获取用户名
          password: ${{ secrets.DOCKER_PASSWORD }} # 从 secrets 获取密码

      - name: Push Docker Image
        # 仅在 main 分支执行
        if: github.ref == 'refs/heads/main'
        run: |
          docker tag ${{ matrix.app }}:${{ github.sha }} ${{ secrets.DOCKER_REGISTRY }}/${{ matrix.app }}:latest
          docker push ${{ secrets.DOCKER_REGISTRY }}/${{ matrix.app }}:latest

  # 部署阶段
  deploy:
    needs: [docker, detect-changes]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.changed-packages) }}
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@v1.0.0 # 使用 SSH 连接到服务器
        with:
          host: ${{ secrets.ALIYUN_HOST }} # 阿里云主机地址
          username: ${{ secrets.ALIYUN_USER }} # 阿里云用户名
          key: ${{ secrets.ALIYUN_SSH_KEY }} # SSH 私钥
          script: |
            cd /docker/
            if [ ! -f docker-compose.yml ]; then
              echo "docker-compose.yml 不存在！"
              exit 1
            fi
            echo "停止并删除 ${{ matrix.app }} 容器..."
            docker-compose stop ${{ matrix.app }} && docker-compose rm -f ${{ matrix.app }}
            echo "删除未使用的镜像..."
            docker image prune -a -f
            echo "拉取最新的 ${{ matrix.app }} 镜像..."
            docker pull ${{ secrets.DOCKER_REGISTRY }}/${{ matrix.app }}:latest
  # 通知阶段
  notify:
    needs: [deploy, detect-changes]
    runs-on: ubuntu-latest
    if: success() || failure()
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.changed-packages) }}
    steps:
      - name: Notify
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ 部署成功！"
            echo "应用: ${{ matrix.app }}"
            echo "镜像: ${{ secrets.DOCKER_REGISTRY }}/${{ matrix.app }}:latest"
          else
            echo "❌ 部署失败！"
            echo "应用: ${{ matrix.app }}"
          fi
